<!DOCTYPE html>
<html lang="en">
<head>
  <title>Sucky Trivia</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.debug.min.js"></script>
  <style>
    .navbar {
      margin-bottom: 0;
      border-radius: 0;
      background-color: #3995a2;
      border-color: #208493;
    }
    .navbar-brand {
      padding: 10px 10px;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#"><img src="http://saintfactorstudios.ml/SainTfactorStudiosIP/WingedTTransparent.png" alt="Winged T" height="32" width="32"></a>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
    </div>
  </div>
</nav>
  
<div class="container-fluid text-center">    
  <div class="row content">
    <div class="col-sm-8 col-sm-offset-2 text-left"> 
      <div id="start_screen">
        <h1>Welcome to Sucky Trivia</h1>
      	<input id="new_btn" type="button" value="Start New Game" />
      	<input id="join_btn" type="button" value="Join Game" />
      </div>
      <div id="gm_screen" style="display:none;">
        <h1>Welcome to your game!</h1>
	<h1>Game Code: <span id="room_code" style="font-weight:bold;"></span></h1>
	<div data-bind="foreach: players">
	  <div><span data-bind="text: name"></span> - <span data-bind="attr: { id: guid }"></span></div>
	</div>
      </div>
      <div id="player_connect_screen" style="display:none;">
        <h1>Type in your username and room code</h1>
	<label for="player_username" style="font-weight:bold;">Username: </label><input id="player_username" name="player_username" type="text" />
	<label for="join_room_code" style="font-weight:bold;">Room Code: </label><input id="join_room_code" name="join_room_code" type="text" />
	<input id="join_game" type="button" value="Join" />
      </div>
      <div id="player_game_screen" style="display:none;">
        <h1>Sucky trivia</h1>
	<input id="answer_input" type="text" />
      </div>
      </div>
    </div>
  </div>
</div>


<script>
    gen_room_code = function() {
	return Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5).toUpperCase();
    }

    $(document).ready(function() {
        var socket = io.connect('http://trivia.saintfactorstudios.ml/socket_space');

        socket.on('message', function(data, cb) {
            console.log(data);
        });
	
	$("#new_btn").on("click", function(){
	    room_code = gen_room_code();
	    $("#room_code").html(room_code)
            socket.emit('start_game', { gm_name: "Cookie Masterson", room_code: room_code});
	    $("#start_screen").css("display", "none");
	    $("#gm_screen").css("display", "block");
            
            function GameViewModel() {
	    	var self = this;

		self.players = ko.observableArray([]);

	    	socket.on("player_join", function(data, cb){
		    if(!self.players().some(function(val) { return data.name == val.name; })){
			    self.players.push(data);
		    }
	    	});

		socket.on("push_answer", function(data, cb) {
		    console.log("data caught")
		    $("#" + data.guid).html(data.answer)
		});
	    }
	    ko.applyBindings(new GameViewModel());
 	});
	
	$("#join_btn").on("click", function(){
	    $("#start_screen").css("display", "none");
	    $("#player_connect_screen").css("display", "block");
	});


        $('#join_game').on("click", function() {
            console.log("Sending join request")
            socket.emit('join', {username: $("#player_username").val(), room: $("#join_room_code").val()});
	    $("#player_connect_screen").css("display", "none");
	    $("#player_game_screen").css("display", "block");
        });

	timeout = null;
	post_current_answer = function() {
	  socket.emit('answer_update', $("#answer_input").val())  
	}
	$("#answer_input").on("keyup", function() {
	   clearTimeout(timeout);
           timeout = setTimeout(post_current_answer, 300);
	});
    });
</script>

</body>
</html>
